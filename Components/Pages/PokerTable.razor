@page "/poker-table"
@using GTOTrainerApp.Models
@inject IJSRuntime JSRuntime

<PageTitle>Poker Table - GTO Trainer</PageTitle>

<div class="poker-table-container">
    <div class="poker-table">
        <!-- Community Cards -->
        <div class="community-cards">
            <div class="card-slot @(gameState.CommunityCards.Count > 0 ? "has-card" : "")">
                @if (gameState.CommunityCards.Count > 0)
                {
                    <div class="playing-card @gameState.CommunityCards[0].Suit.ToLower()">
                        <span class="rank">@gameState.CommunityCards[0].Rank</span>
                        <span class="suit">@GetSuitSymbol(gameState.CommunityCards[0].Suit)</span>
                    </div>
                }
            </div>
            <div class="card-slot @(gameState.CommunityCards.Count > 1 ? "has-card" : "")">
                @if (gameState.CommunityCards.Count > 1)
                {
                    <div class="playing-card @gameState.CommunityCards[1].Suit.ToLower()">
                        <span class="rank">@gameState.CommunityCards[1].Rank</span>
                        <span class="suit">@GetSuitSymbol(gameState.CommunityCards[1].Suit)</span>
                    </div>
                }
            </div>
            <div class="card-slot @(gameState.CommunityCards.Count > 2 ? "has-card" : "")">
                @if (gameState.CommunityCards.Count > 2)
                {
                    <div class="playing-card @gameState.CommunityCards[2].Suit.ToLower()">
                        <span class="rank">@gameState.CommunityCards[2].Rank</span>
                        <span class="suit">@GetSuitSymbol(gameState.CommunityCards[2].Suit)</span>
                    </div>
                }
            </div>
            <div class="card-slot @(gameState.CommunityCards.Count > 3 ? "has-card" : "")">
                @if (gameState.CommunityCards.Count > 3)
                {
                    <div class="playing-card @gameState.CommunityCards[3].Suit.ToLower()">
                        <span class="rank">@gameState.CommunityCards[3].Rank</span>
                        <span class="suit">@GetSuitSymbol(gameState.CommunityCards[3].Suit)</span>
                    </div>
                }
            </div>
            <div class="card-slot @(gameState.CommunityCards.Count > 4 ? "has-card" : "")">
                @if (gameState.CommunityCards.Count > 4)
                {
                    <div class="playing-card @gameState.CommunityCards[4].Suit.ToLower()">
                        <span class="rank">@gameState.CommunityCards[4].Rank</span>
                        <span class="suit">@GetSuitSymbol(gameState.CommunityCards[4].Suit)</span>
                    </div>
                }
            </div>
        </div>

        <!-- Pot -->
        <div class="pot">
            <div class="pot-amount">$@gameState.Pot</div>
        </div>

        <!-- Players around the table -->
        @for (int i = 0; i < 8; i++)
        {
            var player = gameState.Players[i];
            var position = GetPlayerPosition(i);
            <div class="player-seat @position @(player.IsActive ? "active" : "") @(player.IsDealer ? "dealer" : "")">
                <div class="player-info">
                    <div class="player-name">@player.Name</div>
                    <div class="player-chips">$@player.Chips</div>
                    <div class="player-bet">@(player.CurrentBet > 0 ? $"Bet: ${player.CurrentBet}" : "")</div>
                </div>
                
                @if (player.HoleCards.Count > 0)
                {
                    <div class="hole-cards">
                        @foreach (var card in player.HoleCards)
                        {
                            <div class="playing-card @card.Suit.ToLower() @(player.IsHuman ? "" : "hidden")">
                                <span class="rank">@card.Rank</span>
                                <span class="suit">@GetSuitSymbol(card.Suit)</span>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- Action buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" @onclick="StartNewGame">New Game</button>
            <button class="btn btn-success" @onclick="DealCards">Deal Cards</button>
            <button class="btn btn-warning" @onclick="NextRound">Next Round</button>
        </div>
    </div>
</div>

@code {
    private GameState gameState = new();

    protected override void OnInitialized()
    {
        InitializeGame();
    }

    private void InitializeGame()
    {
        gameState = new GameState();
        // Initialize 8 players
        for (int i = 0; i < 8; i++)
        {
            gameState.Players.Add(new Player
            {
                Name = i == 0 ? "You" : $"Player {i + 1}",
                Chips = 1000,
                IsHuman = i == 0
            });
        }
    }

    private void StartNewGame()
    {
        InitializeGame();
        StateHasChanged();
    }

    private void DealCards()
    {
        // Simple card dealing logic
        var deck = CreateDeck();
        var random = new Random();
        
        // Deal hole cards
        for (int i = 0; i < 2; i++)
        {
            foreach (var player in gameState.Players)
            {
                if (deck.Count > 0)
                {
                    var cardIndex = random.Next(deck.Count);
                    player.HoleCards.Add(deck[cardIndex]);
                    deck.RemoveAt(cardIndex);
                }
            }
        }
        
        StateHasChanged();
    }

    private void NextRound()
    {
        // Deal community cards based on current round
        var deck = CreateDeck();
        var random = new Random();
        
        if (gameState.CommunityCards.Count == 0)
        {
            // Flop - deal 3 cards
            for (int i = 0; i < 3; i++)
            {
                if (deck.Count > 0)
                {
                    var cardIndex = random.Next(deck.Count);
                    gameState.CommunityCards.Add(deck[cardIndex]);
                    deck.RemoveAt(cardIndex);
                }
            }
        }
        else if (gameState.CommunityCards.Count == 3)
        {
            // Turn - deal 1 card
            if (deck.Count > 0)
            {
                var cardIndex = random.Next(deck.Count);
                gameState.CommunityCards.Add(deck[cardIndex]);
            }
        }
        else if (gameState.CommunityCards.Count == 4)
        {
            // River - deal 1 card
            if (deck.Count > 0)
            {
                var cardIndex = random.Next(deck.Count);
                gameState.CommunityCards.Add(deck[cardIndex]);
            }
        }
        
        StateHasChanged();
    }

    private List<Card> CreateDeck()
    {
        var deck = new List<Card>();
        var suits = new[] { "Hearts", "Diamonds", "Clubs", "Spades" };
        var ranks = new[] { "A", "K", "Q", "J", "10", "9", "8", "7", "6", "5", "4", "3", "2" };
        
        foreach (var suit in suits)
        {
            foreach (var rank in ranks)
            {
                deck.Add(new Card { Suit = suit, Rank = rank });
            }
        }
        
        return deck;
    }

    private string GetPlayerPosition(int index)
    {
        return index switch
        {
            0 => "bottom",
            1 => "bottom-right",
            2 => "right",
            3 => "top-right",
            4 => "top",
            5 => "top-left",
            6 => "left",
            7 => "bottom-left",
            _ => "bottom"
        };
    }

    private string GetSuitSymbol(string suit)
    {
        return suit switch
        {
            "Hearts" => "♥",
            "Diamonds" => "♦",
            "Clubs" => "♣",
            "Spades" => "♠",
            _ => ""
        };
    }
}
